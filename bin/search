#!/usr/bin/env bash
set -euo pipefail

SEARCH_CMD="flask --app search run --host 0.0.0.0 --port 8000"
SEARCH_DB="var/search.sqlite3"
LOGFILE="var/log/search.log"

is_running() {
    pgrep -f "$SEARCH_CMD" > /dev/null 2>&1
}

case "${1:-}" in

  start)
    # 1. Check database exists
    if [ ! -f "$SEARCH_DB" ]; then
      echo "Error: can't find search database $SEARCH_DB"
      echo "Try: ./bin/searchdb"
      exit 1
    fi

    # 2. Check index server running
    if ! ./bin/index status > /dev/null 2>&1; then
      echo "Error: index server is not running"
      echo "Try ./bin/index start"
      exit 1
    fi

    # 3. Prevent double-start
    if is_running; then
      echo "Error: search server is already running"
      exit 1
    fi

    echo "starting search server ..."
    mkdir -p var/log
    rm -f "$LOGFILE"

    # 4. Launch in background, redirect output
    $SEARCH_CMD &> "$LOGFILE" &

    ;;

  stop)
    echo "stopping search server ..."
    # pkill should NOT cause failure if no process found
    pkill -f "$SEARCH_CMD" || true
    ;;

  restart)
    echo "stopping search server ..."
    pkill -f "$SEARCH_CMD" || true
    echo "starting search server ..."
    mkdir -p var/log
    rm -f "$LOGFILE"
    $SEARCH_CMD &> "$LOGFILE" &
    ;;

  status)
    if is_running; then
      echo "search server running"
      exit 0
    else
      echo "search server stopped"
      exit 1
    fi
    ;;

  *)
    echo "Usage: bin/search {start|stop|restart|status}"
    exit 1
    ;;

esac
